<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>OpenCV WebRTC Streamer</title>
    <style>
        body {
            font-family: sans-serif;
        }

        video {
            width: 640px;
            height: 480px;
            background: #000;
            display: block;
            margin-top: 1em;
        }

        #controls button {
            margin-right: 0.5em;
        }
    </style>
</head>

<body>
    <h3>Local OpenCV → WebRTC demo</h3>
    <div id="controls">
        <button data-cmd="start">Start Stream</button>
        <button data-cmd="pause">Pause Stream</button>
        <button data-cmd="stop">Stop Stream</button>
    </div>
    <p id="status">Idle</p>
    <video id="video" autoplay playsinline muted></video>

    <script>
        (async () => {
            const statusEl = document.getElementById('status');
            const setStatus = (s) => statusEl.innerText = s;

            const pc = new RTCPeerConnection({ bundlePolicy: 'max-bundle' });

            pc.ontrack = (e) => {
                document.getElementById('video').srcObject = e.streams[0];
                setStatus('Receiving remote stream');
            };

            // Fetch offer
            setStatus('Fetching offer...');
            try {
                const offerResp = await fetch('/offer');
                if (!offerResp.ok) throw new Error("Offer not ready");
                const offer = await offerResp.json();

                await pc.setRemoteDescription(offer);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                await fetch('/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(answer)
                });

                setStatus('Connected — waiting video...');
            } catch (err) {
                console.error(err);
                setStatus('Connection failed: ' + err.message);
                return;
            }

            // Generic control handler
            async function sendCommand(command) {
                try {
                    await fetch('/control', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command })
                    });
                    setStatus(`Command: ${command}`);
                } catch (err) {
                    setStatus(`Failed: ${command}`);
                }
            }

            // Bind buttons
            document.querySelectorAll('#controls button').forEach(btn => {
                btn.addEventListener('click', () => sendCommand(btn.dataset.cmd));
            });

        })();
    </script>
</body>

</html>